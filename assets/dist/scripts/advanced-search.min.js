class AdvancedSearchFilterRecap{constructor(t,e,i){this.$form=t,this.$activeFilterList=e,this.filterObject=void 0,this.parent=i}refresh(){this.buildFilterObjectFromInputs(),this.displayFilters()}buildFilterObjectFromInputs(){const t=[],e=this,i=[];$("input, select",this.$form).each(function(a,s){if(!s.value)return!0;if("checkbox"===s.type&&!$(s).is(":checked"))return!0;const r=e.extractLabelAndValueFromInput(s);r&&(i.includes(r.id)||(i.push(r.id),t.push(r)))}),this.filterObject=t}extractLabelAndValueFromInput(t){let e=null;const i=$(t);let a=i.attr("id"),s=i.val(),r="input";const n=i.closest("fieldset"),o=$("label",n).first().text(),l=i.attr("name");return void 0!==l&&((l.endsWith("[to]")||l.endsWith("[from]"))&&(a=a.replace("from_","").replace("to_",""),e=this.extractFromDateRange(t)),"SELECT"===t.tagName&&(e=this.extractFromSelect(t)),"checkbox"===t.type&&(e=this.extractFromCheckbox(t)),null!==e&&e&&(r=e.type,s=e.val),{id:a,type:r,val:s,name:o})}extractFromDateRange(t){const e=$(t).attr("name").replace("[from]","").replace("[to]","");return{type:"date-range",val:[$('input[name="'+e+'[from]"]').val()||null,$('input[name="'+e+'[to]"]').val()||null].filter(function(t){return null!==t}).join(" - ")}}extractFromSelect(t){return{type:"select",val:Array.from(t.selectedOptions).map(function(t){return t.value?t.innerHTML:null}).filter(function(t){return null!==t}).join(", ")}}extractFromCheckbox(t){return{type:"checkbox",val:$(t).is(":checked")?"fr"===$("html").attr("lang")?"Oui":"Yes":""}}displayFilters(){if(void 0!==this.filterObject){this.$activeFilterList.empty();for(const t in this.filterObject){const e=this.filterObject[t];this.addActiveFilter(e)}}}addActiveFilter(t){const e=t.id,i=t.type,a=t.name,s=t.val,r=$("<li></li>").append($("<span></span>").addClass("label").text(a).attr("title",a)).append($("<span></span>").addClass("value").text(s).attr("title",s)).append($("<div></div>").addClass("remove fa fa-times js-remove-filter")).attr("data-key",e).attr("data-type",i);$(this.$activeFilterList).append(r)}removeActiveFilter(t){var e=this;void 0!==t?e.removeListItem(t):$("li",e.$activeFilterList).each(function(){e.removeListItem(this)})}removeListItem(t){const e=$(t).closest("li");e.length&&(this.parent.clearFilter(e),e.remove())}}const widgetL10n=window.widgetL10n||{},$$1=jQuery;class AdvancedSearch extends Charcoal.Admin.Widget{constructor(t){t.data.properties_options||(t.data.properties_options={}),super(t),Charcoal.Admin.Widget.call(this,t)}init(){this.$form=this.element(),this.$applyBtn=$$1(".js-filter-apply",this.$form),this.$exportBtn=$$1(".js-filter-export",this.$form),this.$sortBtn=$$1(".sort-dropdown",this.$form),this.$activeFilterList=$$1(".active-filters",this.$form),this.totalRows=0,this.isReloading=!1,this.clearOnEmpty=!1,this.filterRecap=new AdvancedSearchFilterRecap(this.$form,this.$activeFilterList,this),this.$form.on("submit.charcoal.search.filter",function(t){t.preventDefault(),t.stopPropagation(),this.submit()}.bind(this));const t=this;this.$activeFilterList.on("click",".js-remove-filter",function(e){t.filterRecap.removeActiveFilter(e.target),0===t.countChanges()&&t.clearOnEmpty&&t.clear()}),this.$form.on("click.charcoal.search.filter",".js-filter-reset",this.clear.bind(this)),this.$form.on("click.charcoal.search.filter",".sort-dropdown + .dropdown-menu>.dropdown-item",this.sort.bind(this)),$$1(".c-filters-tab").on("click",function(){const t=$$1(this).attr("data-tab");$$1(".c-filters-tab").removeClass("active"),$$1(".c-filters-tab button i").addClass("fa-angle-down"),$$1(this).addClass("active"),$$1("button i",this).removeClass("fa-angle-down").addClass("fa-angle-up"),$$1(".c-filter-group.active").removeClass("active"),$$1('.c-filter-group[data-tab="'+t+'"]').addClass("active")}),0===$$1(".c-filters-tab.active").length&&$$1(".c-filters-tab").first().click();const e=this;if($$1(this.$exportBtn).on("click",function(){return e.export(),!1}),this.$form.on("change","input, select",t=>e.onFieldChange(t)),$$1(".datetimepickerinput",this.$form).on("change.datetimepicker",t=>e.onFieldChange(t)),$$1($$1("input:not([type=hidden]), select:not([type=hidden])",this.$form)[0]).trigger("change"),this.countActiveFilters()>0){this.clearOnEmpty=!0;const t=Charcoal.Admin.manager();t.ready(()=>{const e=t.components.widgets;e.length>0&&e.forEach(function(t){if(!t||"function"!=typeof t.set_filters)return this;const e=t.opts("data").total_rows??null;null!==e&&this.setTotalRows(e)}.bind(this))})}}onFieldChange(t){const e=this,i=t.target;let a=$$1(i).attr("id"),s=$$1(i).val();if($$1(i).attr("name")||void 0!==t.date){if("checkbox"===t.target.type&&(s=$$1(i).is(":checked")?"checked":""),void 0!==t.date){const t=$$1("input",i).first(),e=t.attr("name");if(a=t.attr("id"),e.endsWith("[to]")||e.endsWith("[from]")){const t=e.replace("[from]","").replace("[to]","");s=[$$1('input[name="'+t+'[from]"]').val()||null,$$1('input[name="'+t+'[to]"]').val()||null].filter(function(t){return null!==t}).join(" - ")}else s=t.val()}s.length?$$1(i).is("input, select")?$$1(i).addClass("changed"):$$1(i).find("input, select").addClass("changed"):(e.removeActiveFilter(a),$$1(i).is("input, select")?$$1(i).removeClass("changed"):$$1(i).find(".changed").removeClass("changed")),e.filterRecap.refresh(),0===e.countChanges()&&e.clearOnEmpty&&e.clear()}}countActiveFilters(){return $$1("li",this.$activeFilterList).length}cleanFilterId(t){let e=t;return(t.includes("from_input_")||t.includes("to_input_"))&&(e=e.replace("from_","").replace("to_","")),e}removeActiveFilter(t){void 0!==t?(t=this.cleanFilterId(t),t=$$1('li[data-key="'+t+'"]',this.$activeFilterList),this.filterRecap.removeActiveFilter(t.get(0))):this.filterRecap.removeActiveFilter()}setTotalRows(t){this.totalRows=t;const e=$$1(".filters-total-rows").first();e.find(".row-count").text(this.totalRows),e.attr("data-count",this.totalRows)}countChanges(){const t=$$1("input.changed, select.changed",this.$form).length,e=t>0,i=e?"("+t+")":"";return $$1(".js-filter-apply, .js-filter-reset, .js-filter-export",this.$form).prop("disabled",!e),$$1(".btn-label span.active",this.$applyBtn).removeClass("active"),$$1(".btn-label span.active",this.$exportBtn).removeClass("active"),$$1(1===t?".btn-label-singular":".btn-label-plural",this.$applyBtn).addClass("active"),$$1(".filter-apply-count",this.$applyBtn).text(i),$$1(".c-filter-group").each(function(){const t=$$1("input.changed, select.changed",this).length,e=$$1('.c-filters-tab[data-tab="'+$$1(this).data("tab")+'"] .tab-filter-count');e.attr("data-count",t),e.find(".count").text(t)}),t}clear(){return this.removeActiveFilter(),this.$form.find("select").each((t,e)=>{$$1(e).val(""),$$1(e).selectpicker("deselectAll")}),$$1(".datetimepickerinput").each(function(){$$1(".datetimepicker-input",this).val().length&&$$1(this).datetimepicker("clear")}),$$1(".changed",this.$form).removeClass("changed"),$$1("input, select",this.$form).prop("required",!1),this.countChanges(),$$1("li",this.$activeFilterList).remove(),$$1(this.$sortBtn).removeClass("selected"),this.submit(),this}clearFilter(t){if(!$$1(t).length)return;const e=$$1(t).data("key"),i=$$1(t).data("type");let a,s;switch(i.includes("date")?"date-range"===i?(s="date-range",a=$$1("#from_"+e,this.$form)):(s="date",a=$$1("#"+e,this.$form)):(a=$$1("#"+e,this.$form),s=a.length?a[0].type:"unknown"),s){case"checkbox":a.prop("checked",!1);break;case"select-one":case"select-multiple":$$1(a).val(""),$$1(a).selectpicker("refresh");break;case"date-range":a.closest("fieldset").find(".datetimepickerinput").datetimepicker("clear"),a.closest("fieldset").find(".changed").removeClass("changed");break;default:a.val("")}return $$1(a).removeClass("changed"),this}sort(t){const e=$$1(t.target).closest(".dropdown-item"),i=$$1(".btn-label",e).text();return $$1(e).hasClass("default")?$$1(this.$sortBtn).removeClass("selected"):($$1(this.$sortBtn).addClass("selected").data({property:e.data("property"),direction:e.data("direction")}),$$1(".sort-option",this.$sortBtn).find(".sort-option-value").text(i)),this.submit(),this}filterObj(t,e,i){const a=$$1(t).closest(".form-field").data("operator")||"";if(this.name=e,this.value=i,this.operator="=",this.type=t.type,this.parseInvalidBetween=function(t,e){this.type="date",this.value=e,this.operator=t.endsWith("[from]")?">":"<"},a.length&&(this.operator=a),"text"===this.type&&"LIKE"===this.operator&&(this.value="%"+this.value+"%"),"checkbox"===this.type&&(this.value=t.checked),"select-multiple"===this.type&&(this.value=$$1(t).val(),"FIND_IN_SET"!==this.operator&&(this.operator="IN")),e.endsWith("[from]")||e.endsWith("[to]")){this.type="daterange",this.operator="BETWEEN",this.matching=e.endsWith("[from]")?e.replace("[from]","[to]"):e.replace("[to]","[from]");const t=$$1('input[name="'+this.matching+'"]').val();this.value.length&&t.length||(this.value.length?this.parseInvalidBetween(this.name,this.value):this.parseInvalidBetween(this.matching,t))}}submit(){let t,e,i,a,s=[];const r=this;return e=Charcoal.Admin.manager(),i=e.components.widgets,i.length>0&&(this.$form.serializeArray(),t=this.$form.find(":input.changed"),$$1.each(t,function(t,e){e.value&&s.push(new r.filterObj(e,e.name,e.value))}),this.clearOnEmpty=s.length>0,a=this.prepare_request(s),i.forEach(function(t){this.dispatch(a,t)}.bind(this))),this}export(){let t,e,i,a,s,r=[];const n=this;if(i=Charcoal.Admin.manager(),a=i.components.widgets,a.length>0){t=this.$form.serializeArray(),e=this.$form.find(":input.changed"),$$1.each(e,function(t,e){e.value&&r.push(new n.filterObj(e,e.name,e.value))}),s=this.prepare_request(r),a.forEach(function(e){if("function"!=typeof e.set_filters)return;t={widget_type:e.widget_type(),widget_options:e.widget_options(),with_data:!0};const i=[];s.filters&&i.push(s.filters);const a=[];s.orders&&a.push(s.orders),t.widget_options.collection_config.filters=i||{},t.widget_options.collection_config.orders=a||{}}.bind(this));const i=Charcoal.Admin.admin_url()+"advanced-search/export"+window.location.search;let o,l,c;$$1(this.$form).addClass("loading"),this.reloadXHR=$$1.ajax({type:"POST",url:i,data:JSON.stringify(t),dataType:"json",contentType:"application/json"}),o=function(t){if("string"!=typeof t.widget_id)return t.feedbacks.push({level:"error",message:widgetL10n.loadingFailed}),void l.call(this,t);const e=t.widget_id;if(n.set_id(e),n.add_opts("id",e),n.add_opts("widget_id",e),n.widget_id=e,"string"!=typeof t.file)return t.feedbacks.push({level:"error",message:widgetL10n.loadingFailed}),void l.call(this,t);window.location.href=Charcoal.Admin.admin_url()+"advanced-search/download?filename="+t.file},l=function(t){t.feedbacks.length?Charcoal.Admin.feedback(t.feedbacks):Charcoal.Admin.feedback([{level:"error",message:widgetL10n.loadingFailed}])},c=function(){n.suppress_feedback()||Charcoal.Admin.feedback().dispatch(),$$1(n.$form).removeClass("loading")},Charcoal.Admin.resolveSimpleJsonXhr(this.reloadXHR,o,l,c)}return this}prepare_request(t){let e,i=null,a=[];const s=this.opts("data"),r=$$1(this.$sortBtn).data("property"),n=this.opts("collection_table");return t.forEach(function(t){const i=t.name.replace(/(\[.*)/gi,"");let r=null,o=[];if(e=s.properties_options[i]||{},void 0!==e.table&&e.table!==n&&(r=e.table||null),void 0!==t&&"daterange"===t.type){if("BETWEEN"===t.operator&&t.name.endsWith("[to]"))return!1;const e=$$1('input[name="'+t.matching+'"]').val();o=t.name.endsWith("[from]")?[t.value,e]:[e,t.value]}a.push({conjunction:e.conjunction||"AND",table:r,property:i,value:o.length?o:t.value,operator:t.operator})}),i={filters:null,orders:null},a.length&&(i.filters={filters:a,name:"advanced-search",table:n}),$$1(this.$sortBtn).hasClass("selected")&&r&&(i.orders={direction:$$1(this.$sortBtn).data("direction"),mode:$$1(this.$sortBtn).data("direction"),property:r}),i}dispatch(t,e){if(this.isReloading||!e||"function"!=typeof e.set_filters)return this;void 0!==e.pagination&&(e.pagination.page=1);const i=[];i.push({conjunction:"AND",name:"isAdvancedSearch",condition:"(1 = 1)"}),t.filters&&i.push(t.filters),e.set_filters(i);const a=[];t.orders&&a.push(t.orders),$$1(this.$form).addClass("loading"),this.isReloading=!0,e.set_orders(a);const s=this.opts("site_search");if(s.length>0){var r=Charcoal.Admin.manager().get_widget(s);"function"==typeof e.set_search_query&&(r.set_search_query(r.$input.val()),e.set_search_query(r.search_query())),"function"==typeof e.set_filter&&e.set_filter("search",r.search_filters())}return e.reload(function(t){t&&this.setTotalRows(t.widget_data.total_rows),$$1(this.$form).removeClass("loading"),this.isReloading=!1}.bind(this),!0),this}}jQuery,Charcoal.Admin.Widget_Advanced_Search=AdvancedSearch,Charcoal.Admin.Widget_Advanced_Search_Tabs=AdvancedSearch;
//# sourceMappingURL=advanced-search.min.js.map