/*! @locomotivemtl/charcoal-contrib-search-filter 13-01-2022 */

!function(t){var e=function(t){console.log(t),t.data.properties_options||(t.data.properties_options={}),Charcoal.Admin.Widget.call(this,t)};(e.prototype=Object.create(Charcoal.Admin.Widget.prototype)).constructor=Charcoal.Admin.Widget_Search_Filter,e.prototype.parent=Charcoal.Admin.Widget.prototype,e.prototype.init=function(){this.$form=this.element(),this.$applyBtn=t(".js-filter-apply",this.$form),this.$form.on("submit.charcoal.search.filter",function(t){t.preventDefault(),t.stopPropagation(),this.submit()}.bind(this)),this.$form.on("click.charcoal.search.filter",".js-filter-reset",this.clear.bind(this)),t(".c-filters-tab").on("click",function(){var e=t(this).attr("data-tab");t(".c-filters-tab").removeClass("active"),t(".c-filters-tab button i").addClass("fa-angle-down"),t(this).addClass("active"),t("button i",this).removeClass("fa-angle-down").addClass("fa-angle-up"),t(".c-filter-group.active").removeClass("active"),t('.c-filter-group[data-tab="'+e+'"]').addClass("active")}),0===t(".c-filters-tab.active").length&&t(".c-filters-tab").first().click();var e=this;t("input, select",this.$form).on("change",function(){t(this).addClass("changed"),e.countChanges()})},e.prototype.countChanges=function(){var e=t("input.changed, select.changed",this.$form).length,a="";e>0?(a="("+e+")",t(".js-filter-apply, .js-filter-reset",this.$form).prop("disabled",!1)):t(".js-filter-apply, .js-filter-reset",this.$form).prop("disabled",!0),t(".btn-label span.active",this.$applyBtn).removeClass("active"),1===e?t(".btn-label-singular",this.$applyBtn).addClass("active"):t(".btn-label-plural",this.$applyBtn).addClass("active"),t(".filter-apply-count",this.$applyBtn).text(a)},e.prototype.clear=function(){return this.$form[0].reset(),this.$form.find("select").selectpicker("refresh"),t("input.changed, select.changed",this.$form).removeClass("changed"),this.countChanges(),this.submit(),this},e.prototype.submit=function(){var e,a,i,r,s={};return a=Charcoal.Admin.manager(),(i=a.components.widgets).length>0&&(this.$form.serializeArray(),e=this.$form.find(":input").serializeArray(),t.each(e,function(t,e){var a=e.name.replace(/(\[.*)/gi,"");e.value&&(s.hasOwnProperty(a)||(s[a]=[]),s[a].push(e.value))}),r=this.prepare_request(s),t.each(i,function(t,e){this.dispatch(r,e)}.bind(this))),this},e.prototype.prepare_request=function(e){var a,i,r=null,s=[],n=this.opts("data"),o=this.opts("collection_table");return t.each(e,function(e,r){a=[];var l=null;void 0!==(i=n.properties_options[e]||{}).table&&i.table!==o&&(l=i.table||null),t.each(r,function(t,i){a.push({property:e,value:i,table:l})}),s.push({conjunction:i.conjunction||"AND",table:l,filters:a})}),s.length&&(r={filters:s,table:o}),console.log(s),r},e.prototype.dispatch=function(t,e){if(!e)return this;if("function"!=typeof e.set_filters)return this;void 0!==e.pagination&&(e.pagination.page=1);var a=[];return t&&a.push(t),e.set_filters(a),e.reload(),this},Charcoal.Admin.Widget_Search_Filter=e,Charcoal.Admin.Widget_Search_Filter_Tabs=e}(jQuery);