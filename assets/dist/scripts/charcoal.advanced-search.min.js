/*! @locomotivemtl/charcoal-contrib-advanced-search 08-01-2024 */

!function(){function t(e,i,r){function n(o,s){if(!i[o]){if(!e[o]){var l="function"==typeof require&&require;if(!s&&l)return l(o,!0);if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=i[o]={exports:{}};e[o][0].call(u.exports,function(t){return n(e[o][1][t]||t)},u,u.exports,t,e,i,r)}return i[o].exports}for(var a="function"==typeof require&&require,o=0;o<r.length;o++)n(r[o]);return n}return t}()({1:[function(t,e,i){"use strict";function r(t){"@babel/helpers - typeof";return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,function(t){var e=function(t,e){if("object"!==r(t)||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!==r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"===r(e)?e:String(e)}(n.key),n)}}function a(t,e){return(a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function o(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var i,n=l(t);if(e){var a=l(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return function(t,e){{if(e&&("object"===r(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined")}return s(t)}(this,i)}}function s(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function l(t){return(l=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}Object.defineProperty(i,"__esModule",{value:!0}),i.default=void 0;var c=function(t){return t&&t.__esModule?t:{default:t}}(t("./filter-recap")),u=window.widgetL10n||{},f=jQuery,d=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),t.data.properties_options||(t.data.properties_options={}),r=i.call(this,t),Charcoal.Admin.Widget.call(s(r),t),r}!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&a(t,e)}(e,Charcoal.Admin.Widget);var i=o(e);return function(t,e,i){e&&n(t.prototype,e),i&&n(t,i),Object.defineProperty(t,"prototype",{writable:!1})}(e,[{key:"init",value:function(){var t=this;this.$form=this.element(),this.$applyBtn=f(".js-filter-apply",this.$form),this.$exportBtn=f(".js-filter-export",this.$form),this.$sortBtn=f(".sort-dropdown",this.$form),this.$activeFilterList=f(".active-filters",this.$form),this.totalRows=0,this.isReloading=!1,this.clearOnEmpty=!1,this.filterRecap=new c.default(this.$form,this.$activeFilterList,this),this.$form.on("submit.charcoal.search.filter",function(t){t.preventDefault(),t.stopPropagation(),this.submit()}.bind(this));var e=this;this.$activeFilterList.on("click",".js-remove-filter",function(t){e.filterRecap.removeActiveFilter(t.target),0===e.countChanges()&&e.clearOnEmpty&&e.clear()}),this.$form.on("click.charcoal.search.filter",".js-filter-reset",this.clear.bind(this)),this.$form.on("click.charcoal.search.filter",".sort-dropdown + .dropdown-menu>.dropdown-item",this.sort.bind(this)),f(".c-filters-tab").on("click",function(){var t=f(this).attr("data-tab");f(".c-filters-tab").removeClass("active"),f(".c-filters-tab button i").addClass("fa-angle-down"),f(this).addClass("active"),f("button i",this).removeClass("fa-angle-down").addClass("fa-angle-up"),f(".c-filter-group.active").removeClass("active"),f('.c-filter-group[data-tab="'+t+'"]').addClass("active")}),0===f(".c-filters-tab.active").length&&f(".c-filters-tab").first().click();var i=this;if(f(this.$exportBtn).on("click",function(){return i.export(),!1}),f("input, select",this.$form).on("change",function(t){return i.onFieldChange(t)}),f(".datetimepickerinput",this.$form).on("change.datetimepicker",function(t){return i.onFieldChange(t)}),f(f("input:not([type=hidden]), select:not([type=hidden])",this.$form)[0]).trigger("change"),this.countActiveFilters()>0){this.clearOnEmpty=!0;var r=Charcoal.Admin.manager();r.ready(function(){var e=r.components.widgets;e.length>0&&e.forEach(function(t){var e;if(!t||"function"!=typeof t.set_filters)return this;var i=null!==(e=t.opts("data").total_rows)&&void 0!==e?e:null;null!==i&&this.setTotalRows(i)}.bind(t))})}}},{key:"onFieldChange",value:function(t){var e=t.target,i=f(e).attr("id"),r=f(e).val();if("checkbox"===t.target.type&&(r=f(e).is(":checked")?"checked":""),void 0!==t.date){var n=f("input",e).first(),a=n.attr("name");if(i=n.attr("id"),a.endsWith("[to]")||a.endsWith("[from]")){var o=a.replace("[from]","").replace("[to]","");r=[f('input[name="'+o+'[from]"]').val()||null,f('input[name="'+o+'[to]"]').val()||null].filter(function(t){return null!==t}).join(" - ")}else r=n.val()}r.length?f(e).is("input, select")?f(e).addClass("changed"):f(e).find("input, select").addClass("changed"):(this.removeActiveFilter(i),f(e).is("input, select")?f(e).removeClass("changed"):f(e).find(".changed").removeClass("changed")),this.filterRecap.refresh(),0===this.countChanges()&&this.clearOnEmpty&&this.clear()}},{key:"countActiveFilters",value:function(){return f("li",this.$activeFilterList).length}},{key:"cleanFilterId",value:function(t){var e=t;return(t.includes("from_input_")||t.includes("to_input_"))&&(e=e.replace("from_","").replace("to_","")),e}},{key:"removeActiveFilter",value:function(t){void 0!==t?(t=this.cleanFilterId(t),t=f('li[data-key="'+t+'"]',this.$activeFilterList),this.filterRecap.removeActiveFilter(t.get(0))):this.filterRecap.removeActiveFilter()}},{key:"setTotalRows",value:function(t){this.totalRows=t;var e=f(".filters-total-rows").first();e.find(".row-count").text(this.totalRows),e.attr("data-count",this.totalRows)}},{key:"countChanges",value:function(){var t=f("input.changed, select.changed",this.$form).length,e=t>0,i=e?"("+t+")":"";return f(".js-filter-apply, .js-filter-reset, .js-filter-export",this.$form).prop("disabled",!e),f(".btn-label span.active",this.$applyBtn).removeClass("active"),f(".btn-label span.active",this.$exportBtn).removeClass("active"),f(1===t?".btn-label-singular":".btn-label-plural",this.$applyBtn).addClass("active"),f(".filter-apply-count",this.$applyBtn).text(i),f(".c-filter-group").each(function(){var t=f("input.changed, select.changed",this).length,e=f('.c-filters-tab[data-tab="'+f(this).data("tab")+'"] .tab-filter-count');e.attr("data-count",t),e.find(".count").text(t)}),t}},{key:"clear",value:function(){return this.removeActiveFilter(),this.$form.find("select").each(function(t,e){f(e).val(""),f(e).selectpicker("deselectAll")}),f(".datetimepickerinput").each(function(){f(".datetimepicker-input",this).val().length&&f(this).datetimepicker("clear")}),f(".changed",this.$form).removeClass("changed"),f("input, select",this.$form).prop("required",!1),this.countChanges(),f("li",this.$activeFilterList).remove(),f(this.$sortBtn).removeClass("selected"),this.submit(),this}},{key:"clearFilter",value:function(t){if(f(t).length){var e,i,r=f(t).data("key"),n=f(t).data("type");switch(n.includes("date")?"date-range"===n?(i="date-range",e=f("#from_"+r,this.$form)):(i="date",e=f("#"+r,this.$form)):i=(e=f("#"+r,this.$form)).length?e[0].type:"unknown",i){case"checkbox":e.prop("checked",!1);break;case"select-one":case"select-multiple":f(e).val(""),f(e).selectpicker("refresh");break;case"date-range":e.closest("fieldset").find(".datetimepickerinput").datetimepicker("clear"),e.closest("fieldset").find(".changed").removeClass("changed");break;default:e.val("")}return f(e).removeClass("changed"),this}}},{key:"sort",value:function(t){var e=f(t.target).closest(".dropdown-item"),i=f(".btn-label",e).text();return f(e).hasClass("default")?f(this.$sortBtn).removeClass("selected"):(f(this.$sortBtn).addClass("selected").data({property:e.data("property"),direction:e.data("direction")}),f(".sort-option",this.$sortBtn).find(".sort-option-value").text(i)),this.submit(),this}},{key:"filterObj",value:function(t,e,i){var r=f(t).closest(".form-field").data("operator")||"";if(this.name=e,this.value=i,this.operator="=",this.type=t.type,this.parseInvalidBetween=function(t,e){this.type="date",this.value=e,this.operator=t.endsWith("[from]")?">":"<"},r.length&&(this.operator=r),"text"===this.type&&"LIKE"===this.operator&&(this.value="%"+this.value+"%"),"checkbox"===this.type&&(this.value=t.checked),"select-multiple"===this.type&&(this.value=f(t).val(),this.operator="IN"),e.endsWith("[from]")||e.endsWith("[to]")){this.type="daterange",this.operator="BETWEEN",this.matching=e.endsWith("[from]")?e.replace("[from]","[to]"):e.replace("[to]","[from]");var n=f('input[name="'+this.matching+'"]').val();this.value.length&&n.length||(this.value.length?this.parseInvalidBetween(this.name,this.value):this.parseInvalidBetween(this.matching,n))}}},{key:"submit",value:function(){var t,e,i,r,n=[],a=this;return e=Charcoal.Admin.manager(),(i=e.components.widgets).length>0&&(this.$form.serializeArray(),t=this.$form.find(":input.changed"),f.each(t,function(t,e){e.value&&n.push(new a.filterObj(e,e.name,e.value))}),this.clearOnEmpty=n.length>0,r=this.prepare_request(n),i.forEach(function(t){this.dispatch(r,t)}.bind(this))),this}},{key:"export",value:function(){var t,e,i,r,n,a=[],o=this;if(i=Charcoal.Admin.manager(),(r=i.components.widgets).length>0){t=this.$form.serializeArray(),e=this.$form.find(":input.changed"),f.each(e,function(t,e){e.value&&a.push(new o.filterObj(e,e.name,e.value))}),n=this.prepare_request(a),r.forEach(function(e){if("function"==typeof e.set_filters){t={widget_type:e.widget_type(),widget_options:e.widget_options(),with_data:!0};var i=[];n.filters&&i.push(n.filters);var r=[];n.orders&&r.push(n.orders),t.widget_options.collection_config.filters=i||{},t.widget_options.collection_config.orders=r||{}}}.bind(this));var s=Charcoal.Admin.admin_url()+"advanced-search/export"+window.location.search;f(this.$form).addClass("loading"),this.reloadXHR=f.ajax({type:"POST",url:s,data:JSON.stringify(t),dataType:"json",contentType:"application/json"});var l,c,d;l=function(t){if("string"!=typeof t.widget_id)return t.feedbacks.push({level:"error",message:u.loadingFailed}),void c.call(this,t);var e=t.widget_id;if(o.set_id(e),o.add_opts("id",e),o.add_opts("widget_id",e),o.widget_id=e,"string"!=typeof t.file)return t.feedbacks.push({level:"error",message:u.loadingFailed}),void c.call(this,t);window.location.href=Charcoal.Admin.admin_url()+"advanced-search/download?filename="+t.file},c=function(t){t.feedbacks.length?Charcoal.Admin.feedback(t.feedbacks):Charcoal.Admin.feedback([{level:"error",message:u.loadingFailed}])},d=function(){o.suppress_feedback()||Charcoal.Admin.feedback().dispatch(),f(o.$form).removeClass("loading")},Charcoal.Admin.resolveSimpleJsonXhr(this.reloadXHR,l,c,d)}return this}},{key:"prepare_request",value:function(t){var e,i=null,r=[],n=this.opts("data"),a=f(this.$sortBtn).data("property"),o=this.opts("collection_table");return t.forEach(function(t){var i=t.name.replace(/(\[.*)/gi,""),a=null,s=[];if(void 0!==(e=n.properties_options[i]||{}).table&&e.table!==o&&(a=e.table||null),void 0!==t&&"daterange"===t.type){if("BETWEEN"===t.operator&&t.name.endsWith("[to]"))return!1;var l=f('input[name="'+t.matching+'"]').val();s=t.name.endsWith("[from]")?[t.value,l]:[l,t.value]}r.push({conjunction:e.conjunction||"AND",table:a,property:i,value:s.length?s:t.value,operator:t.operator})}),i={filters:null,orders:null},r.length&&(i.filters={filters:r,table:o}),f(this.$sortBtn).hasClass("selected")&&a&&(i.orders={direction:f(this.$sortBtn).data("direction"),mode:f(this.$sortBtn).data("direction"),property:a}),i}},{key:"dispatch",value:function(t,e){if(this.isReloading||!e||"function"!=typeof e.set_filters)return this;void 0!==e.pagination&&(e.pagination.page=1);var i=[];i.push({conjunction:"AND",name:"isAdvancedSearch",condition:"(1 = 1)"}),t.filters&&i.push(t.filters),e.set_filters(i);var r=[];t.orders&&r.push(t.orders),f(this.$form).addClass("loading"),this.isReloading=!0,e.set_orders(r);var n=this.opts("site_search");if(n.length>0){var a=Charcoal.Admin.manager().get_widget(n);"function"==typeof e.set_search_query&&(a.set_search_query(a.$input.val()),e.set_search_query(a.search_query())),"function"==typeof e.set_filter&&e.set_filter("search",a.search_filters())}return e.reload(function(t){t&&this.setTotalRows(t.widget_data.total_rows),f(this.$form).removeClass("loading"),this.isReloading=!1}.bind(this),!0),this}}]),e}();i.default=d},{"./filter-recap":2}],2:[function(t,e,i){"use strict";function r(t){"@babel/helpers - typeof";return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,function(t){var e=function(t,e){if("object"!==r(t)||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!==r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"===r(e)?e:String(e)}(n.key),n)}}Object.defineProperty(i,"__esModule",{value:!0}),i.default=void 0;var a=function(){function t(e,i,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.$form=e,this.$activeFilterList=i,this.filterObject=void 0,this.parent=r}return function(t,e,i){e&&n(t.prototype,e),i&&n(t,i),Object.defineProperty(t,"prototype",{writable:!1})}(t,[{key:"refresh",value:function(){this.buildFilterObjectFromInputs(),this.displayFilters()}},{key:"buildFilterObjectFromInputs",value:function(){var t=[],e=this,i=[];$("input, select",this.$form).each(function(r,n){if(!n.value)return!0;if("checkbox"===n.type&&!$(n).is(":checked"))return!0;var a=e.extractLabelAndValueFromInput(n);a&&(i.includes(a.id)||(i.push(a.id),t.push(a)))}),this.filterObject=t}},{key:"extractLabelAndValueFromInput",value:function(t){var e=null,i=$(t),r=i.attr("id"),n=i.val(),a="input",o=i.closest("fieldset"),s=$("label",o).first().text(),l=i.attr("name");return void 0!==l&&((l.endsWith("[to]")||l.endsWith("[from]"))&&(r=r.replace("from_","").replace("to_",""),e=this.extractFromDateRange(t)),"SELECT"===t.tagName&&(e=this.extractFromSelect(t)),"checkbox"===t.type&&(e=this.extractFromCheckbox(t)),null!==e&&e&&(a=e.type,n=e.val),{id:r,type:a,val:n,name:s})}},{key:"extractFromDateRange",value:function(t){var e=$(t).attr("name").replace("[from]","").replace("[to]","");return{type:"date-range",val:[$('input[name="'+e+'[from]"]').val()||null,$('input[name="'+e+'[to]"]').val()||null].filter(function(t){return null!==t}).join(" - ")}}},{key:"extractFromSelect",value:function(t){return{type:"select",val:Array.from(t.selectedOptions).map(function(t){return t.value?t.innerHTML:null}).filter(function(t){return null!==t}).join(", ")}}},{key:"extractFromCheckbox",value:function(t){return{type:"checkbox",val:$(t).is(":checked")?"fr"===$("html").attr("lang")?"Oui":"Yes":""}}},{key:"displayFilters",value:function(){if(void 0!==this.filterObject){this.$activeFilterList.empty();for(var t in this.filterObject){var e=this.filterObject[t];this.addActiveFilter(e)}}}},{key:"addActiveFilter",value:function(t){var e=t.id,i=t.type,r=t.name,n=t.val,a=$("<li></li>").append($("<span></span>").addClass("label").text(r).attr("title",r)).append($("<span></span>").addClass("value").text(n).attr("title",n)).append($("<div></div>").addClass("remove fa fa-times js-remove-filter")).attr("data-key",e).attr("data-type",i);$(this.$activeFilterList).append(a)}},{key:"removeActiveFilter",value:function(t){var e=this;void 0!==t?e.removeListItem(t):$("li",e.$activeFilterList).each(function(){e.removeListItem(this)})}},{key:"removeListItem",value:function(t){var e=$(t).closest("li");e.length&&(this.parent.clearFilter(e),e.remove())}}]),t}();i.default=a},{}],3:[function(t,e,i){"use strict";var r=function(t){return t&&t.__esModule?t:{default:t}}(t("./advanced-search"));jQuery,Charcoal.Admin.Widget_Advanced_Search=r.default,Charcoal.Admin.Widget_Advanced_Search_Tabs=r.default},{"./advanced-search":1}]},{},[3]);