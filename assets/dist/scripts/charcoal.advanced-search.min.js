!function t(e,i,r){function n(o,s){if(!i[o]){if(!e[o]){var l="function"==typeof require&&require;if(!s&&l)return l(o,!0);if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=i[o]={exports:{}};e[o][0].call(u.exports,(function(t){return n(e[o][1][t]||t)}),u,u.exports,t,e,i,r)}return i[o].exports}for(var a="function"==typeof require&&require,o=0;o<r.length;o++)n(r[o]);return n}({1:[function(t,e,i){"use strict";function r(t){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}Object.defineProperty(i,"__esModule",{value:!0}),i.default=void 0;var n,a=(n=t("./filter-recap"))&&n.__esModule?n:{default:n};function o(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,s(r.key),r)}}function s(t){var e=function(t,e){if("object"!=r(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==r(e)?e:e+""}function l(t,e,i){return e=u(e),function(t,e){if(e&&("object"==r(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,c()?Reflect.construct(e,i||[],u(t).constructor):e.apply(t,i))}function c(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(c=function(){return!!t})()}function u(t){return u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},u(t)}function f(t,e){return f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},f(t,e)}var d=window.widgetL10n||{},h=jQuery,p=function(){function t(e){var i;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),e.data.properties_options||(e.data.properties_options={}),i=l(this,t,[e]),Charcoal.Admin.Widget.call(i,e),i}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&f(t,e)}(t,Charcoal.Admin.Widget),function(t,e,i){return e&&o(t.prototype,e),i&&o(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(t,[{key:"init",value:function(){var t=this;this.$form=this.element(),this.$applyBtn=h(".js-filter-apply",this.$form),this.$exportBtn=h(".js-filter-export",this.$form),this.$sortBtn=h(".sort-dropdown",this.$form),this.$activeFilterList=h(".active-filters",this.$form),this.totalRows=0,this.isReloading=!1,this.clearOnEmpty=!1,this.filterRecap=new a.default(this.$form,this.$activeFilterList,this),this.$form.on("submit.charcoal.search.filter",function(t){t.preventDefault(),t.stopPropagation(),this.submit()}.bind(this));var e=this;this.$activeFilterList.on("click",".js-remove-filter",(function(t){e.filterRecap.removeActiveFilter(t.target),0===e.countChanges()&&e.clearOnEmpty&&e.clear()})),this.$form.on("click.charcoal.search.filter",".js-filter-reset",this.clear.bind(this)),this.$form.on("click.charcoal.search.filter",".sort-dropdown + .dropdown-menu>.dropdown-item",this.sort.bind(this)),h(".c-filters-tab").on("click",(function(){var t=h(this).attr("data-tab");h(".c-filters-tab").removeClass("active"),h(".c-filters-tab button i").addClass("fa-angle-down"),h(this).addClass("active"),h("button i",this).removeClass("fa-angle-down").addClass("fa-angle-up"),h(".c-filter-group.active").removeClass("active"),h('.c-filter-group[data-tab="'+t+'"]').addClass("active")})),0===h(".c-filters-tab.active").length&&h(".c-filters-tab").first().click();var i=this;if(h(this.$exportBtn).on("click",(function(){return i.export(),!1})),h("input, select",this.$form).on("change",(function(t){return i.onFieldChange(t)})),h(".datetimepickerinput",this.$form).on("change.datetimepicker",(function(t){return i.onFieldChange(t)})),h(h("input:not([type=hidden]), select:not([type=hidden])",this.$form)[0]).trigger("change"),this.countActiveFilters()>0){this.clearOnEmpty=!0;var r=Charcoal.Admin.manager();r.ready((function(){var e=r.components.widgets;e.length>0&&e.forEach(function(t){var e;if(!t||"function"!=typeof t.set_filters)return this;var i=null!==(e=t.opts("data").total_rows)&&void 0!==e?e:null;null!==i&&this.setTotalRows(i)}.bind(t))}))}}},{key:"onFieldChange",value:function(t){var e=this,i=t.target,r=h(i).attr("id"),n=h(i).val();if("checkbox"===t.target.type&&(n=h(i).is(":checked")?"checked":""),void 0!==t.date){var a=h("input",i).first(),o=a.attr("name");if(r=a.attr("id"),o.endsWith("[to]")||o.endsWith("[from]")){var s=o.replace("[from]","").replace("[to]","");n=[h('input[name="'+s+'[from]"]').val()||null,h('input[name="'+s+'[to]"]').val()||null].filter((function(t){return null!==t})).join(" - ")}else n=a.val()}n.length?h(i).is("input, select")?h(i).addClass("changed"):h(i).find("input, select").addClass("changed"):(e.removeActiveFilter(r),h(i).is("input, select")?h(i).removeClass("changed"):h(i).find(".changed").removeClass("changed")),e.filterRecap.refresh(),0===e.countChanges()&&e.clearOnEmpty&&e.clear()}},{key:"countActiveFilters",value:function(){return h("li",this.$activeFilterList).length}},{key:"cleanFilterId",value:function(t){var e=t;return(t.includes("from_input_")||t.includes("to_input_"))&&(e=e.replace("from_","").replace("to_","")),e}},{key:"removeActiveFilter",value:function(t){void 0!==t?(t=this.cleanFilterId(t),t=h('li[data-key="'+t+'"]',this.$activeFilterList),this.filterRecap.removeActiveFilter(t.get(0))):this.filterRecap.removeActiveFilter()}},{key:"setTotalRows",value:function(t){this.totalRows=t;var e=h(".filters-total-rows").first();e.find(".row-count").text(this.totalRows),e.attr("data-count",this.totalRows)}},{key:"countChanges",value:function(){var t=h("input.changed, select.changed",this.$form).length,e=t>0,i=e?"("+t+")":"";return h(".js-filter-apply, .js-filter-reset, .js-filter-export",this.$form).prop("disabled",!e),h(".btn-label span.active",this.$applyBtn).removeClass("active"),h(".btn-label span.active",this.$exportBtn).removeClass("active"),h(1===t?".btn-label-singular":".btn-label-plural",this.$applyBtn).addClass("active"),h(".filter-apply-count",this.$applyBtn).text(i),h(".c-filter-group").each((function(){var t=h("input.changed, select.changed",this).length,e=h('.c-filters-tab[data-tab="'+h(this).data("tab")+'"] .tab-filter-count');e.attr("data-count",t),e.find(".count").text(t)})),t}},{key:"clear",value:function(){return this.removeActiveFilter(),this.$form.find("select").each((function(t,e){h(e).val(""),h(e).selectpicker("deselectAll")})),h(".datetimepickerinput").each((function(){h(".datetimepicker-input",this).val().length&&h(this).datetimepicker("clear")})),h(".changed",this.$form).removeClass("changed"),h("input, select",this.$form).prop("required",!1),this.countChanges(),h("li",this.$activeFilterList).remove(),h(this.$sortBtn).removeClass("selected"),this.submit(),this}},{key:"clearFilter",value:function(t){if(h(t).length){var e,i,r=h(t).data("key"),n=h(t).data("type");switch(n.includes("date")?"date-range"===n?(i="date-range",e=h("#from_"+r,this.$form)):(i="date",e=h("#"+r,this.$form)):i=(e=h("#"+r,this.$form)).length?e[0].type:"unknown",i){case"checkbox":e.prop("checked",!1);break;case"select-one":case"select-multiple":h(e).val(""),h(e).selectpicker("refresh");break;case"date-range":e.closest("fieldset").find(".datetimepickerinput").datetimepicker("clear"),e.closest("fieldset").find(".changed").removeClass("changed");break;default:e.val("")}return h(e).removeClass("changed"),this}}},{key:"sort",value:function(t){var e=h(t.target).closest(".dropdown-item"),i=h(".btn-label",e).text();return h(e).hasClass("default")?h(this.$sortBtn).removeClass("selected"):(h(this.$sortBtn).addClass("selected").data({property:e.data("property"),direction:e.data("direction")}),h(".sort-option",this.$sortBtn).find(".sort-option-value").text(i)),this.submit(),this}},{key:"filterObj",value:function(t,e,i){var r=h(t).closest(".form-field").data("operator")||"";if(this.name=e,this.value=i,this.operator="=",this.type=t.type,this.parseInvalidBetween=function(t,e){this.type="date",this.value=e,this.operator=t.endsWith("[from]")?">":"<"},r.length&&(this.operator=r),"text"===this.type&&"LIKE"===this.operator&&(this.value="%"+this.value+"%"),"checkbox"===this.type&&(this.value=t.checked),"select-multiple"===this.type&&(this.value=h(t).val(),"FIND_IN_SET"!==this.operator&&(this.operator="IN")),e.endsWith("[from]")||e.endsWith("[to]")){this.type="daterange",this.operator="BETWEEN",this.matching=e.endsWith("[from]")?e.replace("[from]","[to]"):e.replace("[to]","[from]");var n=h('input[name="'+this.matching+'"]').val();this.value.length&&n.length||(this.value.length?this.parseInvalidBetween(this.name,this.value):this.parseInvalidBetween(this.matching,n))}}},{key:"submit",value:function(){var t,e,i,r=[],n=this;return(e=Charcoal.Admin.manager().components.widgets).length>0&&(this.$form.serializeArray(),t=this.$form.find(":input.changed"),h.each(t,(function(t,e){e.value&&r.push(new n.filterObj(e,e.name,e.value))})),this.clearOnEmpty=r.length>0,i=this.prepare_request(r),e.forEach(function(t){this.dispatch(i,t)}.bind(this))),this}},{key:"export",value:function(){var t,e,i,r,n=[],a=this;if((i=Charcoal.Admin.manager().components.widgets).length>0){t=this.$form.serializeArray(),e=this.$form.find(":input.changed"),h.each(e,(function(t,e){e.value&&n.push(new a.filterObj(e,e.name,e.value))})),r=this.prepare_request(n),i.forEach(function(e){if("function"==typeof e.set_filters){t={widget_type:e.widget_type(),widget_options:e.widget_options(),with_data:!0};var i=[];r.filters&&i.push(r.filters);var n=[];r.orders&&n.push(r.orders),t.widget_options.collection_config.filters=i||{},t.widget_options.collection_config.orders=n||{}}}.bind(this));var o,s,l,c=Charcoal.Admin.admin_url()+"advanced-search/export"+window.location.search;h(this.$form).addClass("loading"),this.reloadXHR=h.ajax({type:"POST",url:c,data:JSON.stringify(t),dataType:"json",contentType:"application/json"}),o=function(t){if("string"!=typeof t.widget_id)return t.feedbacks.push({level:"error",message:d.loadingFailed}),void s.call(this,t);var e=t.widget_id;if(a.set_id(e),a.add_opts("id",e),a.add_opts("widget_id",e),a.widget_id=e,"string"!=typeof t.file)return t.feedbacks.push({level:"error",message:d.loadingFailed}),void s.call(this,t);window.location.href=Charcoal.Admin.admin_url()+"advanced-search/download?filename="+t.file},s=function(t){t.feedbacks.length?Charcoal.Admin.feedback(t.feedbacks):Charcoal.Admin.feedback([{level:"error",message:d.loadingFailed}])},l=function(){a.suppress_feedback()||Charcoal.Admin.feedback().dispatch(),h(a.$form).removeClass("loading")},Charcoal.Admin.resolveSimpleJsonXhr(this.reloadXHR,o,s,l)}return this}},{key:"prepare_request",value:function(t){var e,i=null,r=[],n=this.opts("data"),a=h(this.$sortBtn).data("property"),o=this.opts("collection_table");return t.forEach((function(t){var i=t.name.replace(/(\[.*)/gi,""),a=null,s=[];if(void 0!==(e=n.properties_options[i]||{}).table&&e.table!==o&&(a=e.table||null),void 0!==t&&"daterange"===t.type){if("BETWEEN"===t.operator&&t.name.endsWith("[to]"))return!1;var l=h('input[name="'+t.matching+'"]').val();s=t.name.endsWith("[from]")?[t.value,l]:[l,t.value]}r.push({conjunction:e.conjunction||"AND",table:a,property:i,value:s.length?s:t.value,operator:t.operator})})),i={filters:null,orders:null},r.length&&(i.filters={filters:r,name:"advanced-search",table:o}),h(this.$sortBtn).hasClass("selected")&&a&&(i.orders={direction:h(this.$sortBtn).data("direction"),mode:h(this.$sortBtn).data("direction"),property:a}),i}},{key:"dispatch",value:function(t,e){if(this.isReloading||!e||"function"!=typeof e.set_filters)return this;void 0!==e.pagination&&(e.pagination.page=1);var i=[];i.push({conjunction:"AND",name:"isAdvancedSearch",condition:"(1 = 1)"}),t.filters&&i.push(t.filters),e.set_filters(i);var r=[];t.orders&&r.push(t.orders),h(this.$form).addClass("loading"),this.isReloading=!0,e.set_orders(r);var n=this.opts("site_search");if(n.length>0){var a=Charcoal.Admin.manager().get_widget(n);"function"==typeof e.set_search_query&&(a.set_search_query(a.$input.val()),e.set_search_query(a.search_query())),"function"==typeof e.set_filter&&e.set_filter("search",a.search_filters())}return e.reload(function(t){t&&this.setTotalRows(t.widget_data.total_rows),h(this.$form).removeClass("loading"),this.isReloading=!1}.bind(this),!0),this}}])}();i.default=p},{"./filter-recap":2}],2:[function(t,e,i){"use strict";function r(t){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}function n(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,a(r.key),r)}}function a(t){var e=function(t,e){if("object"!=r(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==r(e)?e:e+""}Object.defineProperty(i,"__esModule",{value:!0}),i.default=void 0;var o=function(){return t=function t(e,i,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.$form=e,this.$activeFilterList=i,this.filterObject=void 0,this.parent=r},(e=[{key:"refresh",value:function(){this.buildFilterObjectFromInputs(),this.displayFilters()}},{key:"buildFilterObjectFromInputs",value:function(){var t=[],e=this,i=[];$("input, select",this.$form).each((function(r,n){if(!n.value)return!0;if("checkbox"===n.type&&!$(n).is(":checked"))return!0;var a=e.extractLabelAndValueFromInput(n);a&&(i.includes(a.id)||(i.push(a.id),t.push(a)))})),this.filterObject=t}},{key:"extractLabelAndValueFromInput",value:function(t){var e=null,i=$(t),r=i.attr("id"),n=i.val(),a="input",o=i.closest("fieldset"),s=$("label",o).first().text(),l=i.attr("name");return void 0!==l&&((l.endsWith("[to]")||l.endsWith("[from]"))&&(r=r.replace("from_","").replace("to_",""),e=this.extractFromDateRange(t)),"SELECT"===t.tagName&&(e=this.extractFromSelect(t)),"checkbox"===t.type&&(e=this.extractFromCheckbox(t)),null!==e&&e&&(a=e.type,n=e.val),{id:r,type:a,val:n,name:s})}},{key:"extractFromDateRange",value:function(t){var e=$(t).attr("name").replace("[from]","").replace("[to]","");return{type:"date-range",val:[$('input[name="'+e+'[from]"]').val()||null,$('input[name="'+e+'[to]"]').val()||null].filter((function(t){return null!==t})).join(" - ")}}},{key:"extractFromSelect",value:function(t){return{type:"select",val:Array.from(t.selectedOptions).map((function(t){return t.value?t.innerHTML:null})).filter((function(t){return null!==t})).join(", ")}}},{key:"extractFromCheckbox",value:function(t){return{type:"checkbox",val:$(t).is(":checked")?"fr"===$("html").attr("lang")?"Oui":"Yes":""}}},{key:"displayFilters",value:function(){if(void 0!==this.filterObject)for(var t in this.$activeFilterList.empty(),this.filterObject){var e=this.filterObject[t];this.addActiveFilter(e)}}},{key:"addActiveFilter",value:function(t){var e=t.id,i=t.type,r=t.name,n=t.val,a=$("<li></li>").append($("<span></span>").addClass("label").text(r).attr("title",r)).append($("<span></span>").addClass("value").text(n).attr("title",n)).append($("<div></div>").addClass("remove fa fa-times js-remove-filter")).attr("data-key",e).attr("data-type",i);$(this.$activeFilterList).append(a)}},{key:"removeActiveFilter",value:function(t){var e=this;void 0!==t?e.removeListItem(t):$("li",e.$activeFilterList).each((function(){e.removeListItem(this)}))}},{key:"removeListItem",value:function(t){var e=$(t).closest("li");e.length&&(this.parent.clearFilter(e),e.remove())}}])&&n(t.prototype,e),i&&n(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,i}();i.default=o},{}],3:[function(t,e,i){"use strict";var r,n=(r=t("./advanced-search"))&&r.__esModule?r:{default:r};jQuery,Charcoal.Admin.Widget_Advanced_Search=n.default,Charcoal.Admin.Widget_Advanced_Search_Tabs=n.default},{"./advanced-search":1}]},{},[3]);