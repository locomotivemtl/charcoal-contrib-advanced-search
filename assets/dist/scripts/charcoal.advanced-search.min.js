/*! @locomotivemtl/charcoal-contrib-advanced-search 22-03-2022 */

!function(t){var e=function(t){console.log(t),t.data.properties_options||(t.data.properties_options={}),Charcoal.Admin.Widget.call(this,t)};(e.prototype=Object.create(Charcoal.Admin.Widget.prototype)).constructor=Charcoal.Admin.Widget_Advanced_Search,e.prototype.parent=Charcoal.Admin.Widget.prototype,e.prototype.init=function(){this.$form=this.element(),this.$applyBtn=t(".js-filter-apply",this.$form),this.$sortBtn=t(".sort-dropdown",this.$form),this.$form.on("submit.charcoal.search.filter",function(t){t.preventDefault(),t.stopPropagation(),this.submit()}.bind(this)),this.$form.on("click.charcoal.search.filter",".js-filter-reset",this.clear.bind(this)),this.$form.on("click",".sort-dropdown + .dropdown-menu>.dropdown-item",this.sort.bind(this)),t(".c-filters-tab").on("click",function(){var e=t(this).attr("data-tab");t(".c-filters-tab").removeClass("active"),t(".c-filters-tab button i").addClass("fa-angle-down"),t(this).addClass("active"),t("button i",this).removeClass("fa-angle-down").addClass("fa-angle-up"),t(".c-filter-group.active").removeClass("active"),t('.c-filter-group[data-tab="'+e+'"]').addClass("active")}),0===t(".c-filters-tab.active").length&&t(".c-filters-tab").first().click();var e=this,i=function(){t(this).is("input, select")?t(this).addClass("changed"):t(this).find("input, select").addClass("changed"),e.countChanges()};t("input, select",this.$form).on("change",i),t(".datetimepickerinput",this.$form).on("change.datetimepicker",i)},e.prototype.countChanges=function(){var e=t("input.changed, select.changed",this.$form).length,i="";e>0?(i="("+e+")",t(".js-filter-apply, .js-filter-reset",this.$form).prop("disabled",!1)):t(".js-filter-apply, .js-filter-reset",this.$form).prop("disabled",!0),t(".btn-label span.active",this.$applyBtn).removeClass("active"),1===e?t(".btn-label-singular",this.$applyBtn).addClass("active"):t(".btn-label-plural",this.$applyBtn).addClass("active"),t(".filter-apply-count",this.$applyBtn).text(i)},e.prototype.clear=function(){return this.$form[0].reset(),this.$form.find("select").selectpicker("refresh"),t(".datetimepickerinput").datetimepicker("clear"),t("input.changed, select.changed",this.$form).removeClass("changed"),this.countChanges(),t(this.$sortBtn).removeClass("selected"),this.submit(),this},e.prototype.sort=function(e){console.log("Sort clicked");var i=t(e.target).closest(".dropdown-item"),r=t(".btn-label",i).text();return t(this.$sortBtn).addClass("selected").data({property:i.data("property"),direction:i.data("direction")}),t(".sort-option",this.$sortBtn).find(".sort-option-value").text(r),this.submit(),this},e.prototype.filterObj=function(e,i,r){var a=t(e).closest(".form-field").data("operator")||"";this.name=i,this.value=r,this.operator="=",this.type=e.type,a.length&&(this.operator=a),"checkbox"===this.type&&(this.value=e.checked),(i.endsWith("[from]")||i.endsWith("[to]"))&&(this.type="daterange",this.operator="BETWEEN",this.matching=i.endsWith("[from]")?i.replace("[from]","[to]"):i.replace("[to]","[from]"))},e.prototype.submit=function(){var e,i,r,a,s={},o=this;return i=Charcoal.Admin.manager(),(r=i.components.widgets).length>0&&(this.$form.serializeArray(),e=this.$form.find(":input.changed"),t.each(e,function(t,e){var i=e.name.replace(/(\[.*)/gi,"");e.value&&(console.log(e),s.hasOwnProperty(i)||(s[i]=[]),s[i].push(new o.filterObj(e,e.name,e.value)))}),a=this.prepare_request(s),t.each(r,function(t,e){this.dispatch(a,e)}.bind(this))),this},e.prototype.prepare_request=function(e){var i,r,a=null,s=[],o=this.opts("data"),n=t(this.$sortBtn).data("property"),l=this.opts("collection_table");return t.each(e,function(a,n){i=[];var c=null;void 0!==(r=o.properties_options[a]||{}).table&&r.table!==l&&(c=r.table||null),t.each(n,function(r,s){if(void 0!==s){var o=[];if("daterange"===s.type){var n=t('input[name="'+s.matching+'"]').val();s.name.endsWith("[from]")?(o.push(s.value),o.push(n)):(o.push(n),o.push(s.value)),e[a].pop()}i.push({property:a,value:o.length?o:s.value,operator:s.operator})}}),s.push({conjunction:r.conjunction||"AND",table:c,filters:i})}),a={filters:null,orders:null},s.length&&(a.filters={filters:s,table:l}),t(this.$sortBtn).hasClass("selected")&&n&&(a.orders={direction:t(this.$sortBtn).data("direction"),mode:t(this.$sortBtn).data("direction"),property:n}),console.log(s),a},e.prototype.dispatch=function(t,e){if(!e)return this;if("function"!=typeof e.set_filters)return this;void 0!==e.pagination&&(e.pagination.page=1);var i=[];t.filters&&i.push(t.filters),e.set_filters(i);var r=[];return t.orders&&r.push(t.orders),e.set_orders(r),e.reload(),this},Charcoal.Admin.Widget_Advanced_Search=e,Charcoal.Admin.Widget_Advanced_Search_Tabs=e}(jQuery);