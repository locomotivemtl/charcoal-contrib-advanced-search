/*! @locomotivemtl/charcoal-contrib-advanced-search 27-06-2023 */

!function(t){var e=window.widgetL10n||{},i=function(t){t.data.properties_options||(t.data.properties_options={}),Charcoal.Admin.Widget.call(this,t)};(i.prototype=Object.create(Charcoal.Admin.Widget.prototype)).constructor=Charcoal.Admin.Widget_Advanced_Search,i.prototype.parent=Charcoal.Admin.Widget.prototype,i.prototype.init=function(){this.$form=this.element(),this.$applyBtn=t(".js-filter-apply",this.$form),this.$exportBtn=t(".js-filter-export",this.$form),this.$sortBtn=t(".sort-dropdown",this.$form),this.$activeFilterList=t(".active-filters",this.$form),this.totalRows=0,this.isReloading=!1,this.filterRecap=new AdvancedSearchFilterRecap(this.$form,this.$activeFilterList,this),this.$form.on("submit.charcoal.search.filter",function(t){t.preventDefault(),t.stopPropagation(),this.submit()}.bind(this));var e=this;this.$activeFilterList.on("click",".js-remove-filter",function(t){e.filterRecap.removeActiveFilter(t.target)}),this.$form.on("click.charcoal.search.filter",".js-filter-reset",this.clear.bind(this)),this.$form.on("click.charcoal.search.filter",".sort-dropdown + .dropdown-menu>.dropdown-item",this.sort.bind(this)),t(".c-filters-tab").on("click",function(){var e=t(this).attr("data-tab");t(".c-filters-tab").removeClass("active"),t(".c-filters-tab button i").addClass("fa-angle-down"),t(this).addClass("active"),t("button i",this).removeClass("fa-angle-down").addClass("fa-angle-up"),t(".c-filter-group.active").removeClass("active"),t('.c-filter-group[data-tab="'+e+'"]').addClass("active")}),0===t(".c-filters-tab.active").length&&t(".c-filters-tab").first().click();var i=this,a=function(e){var a=e.target,r=t(a).attr("id"),s=t(a).val();if("checkbox"===e.target.type&&(s=t(a).is(":checked")?"checked":""),void 0!==e.date){var n=t("input",a).first(),o=n.attr("name");if(r=n.attr("id"),o.endsWith("[to]")||o.endsWith("[from]")){var l=o.replace("[from]","").replace("[to]","");s=[t('input[name="'+l+'[from]"]').val()||null,t('input[name="'+l+'[to]"]').val()||null].filter(function(t){return null!==t}).join(" - ")}else s=n.val()}s.length?t(this).is("input, select")?t(this).addClass("changed"):t(this).find("input, select").addClass("changed"):(i.removeActiveFilter(r),t(this).is("input, select")?t(this).removeClass("changed"):t(this).find(".changed").removeClass("changed")),i.filterRecap.refresh(),i.countChanges()};t(this.$exportBtn).on("click",function(){return i.export(),!1}),t("input, select",this.$form).on("change",a),t(".datetimepickerinput",this.$form).on("change.datetimepicker",a)},i.prototype.countActiveFilters=function(){return t("li",this.$activeFilterList).length},i.prototype.cleanFilterId=function(t){var e=t;return(t.includes("from_input_")||t.includes("to_input_"))&&(e=e.replace("from_","").replace("to_","")),e},i.prototype.removeActiveFilter=function(e){e=this.cleanFilterId(e),e=t('li[data-key="'+e+'"]',this.$activeFilterList),this.filterRecap.removeActiveFilter(e.get(0))},i.prototype.setTotalRows=function(e){this.totalRows=e;var i=t(".filters-total-rows").first();i.find(".row-count").text(this.totalRows),i.attr("data-count",this.totalRows)},i.prototype.countChanges=function(){var e=t("input.changed, select.changed",this.$form).length,i="";return e>0?(i="("+e+")",t(".js-filter-apply, .js-filter-reset, .js-filter-export",this.$form).prop("disabled",!1)):t(".js-filter-apply, .js-filter-reset .js-filter-export",this.$form).prop("disabled",!0),t(".btn-label span.active",this.$applyBtn).removeClass("active"),t(".btn-label span.active",this.$exportBtn).removeClass("active"),1===e?t(".btn-label-singular",this.$applyBtn).addClass("active"):t(".btn-label-plural",this.$applyBtn).addClass("active"),t(".filter-apply-count",this.$applyBtn).text(i),t(".c-filter-group").each(function(){var e=t("input.changed, select.changed",this).length,i=t('.c-filters-tab[data-tab="'+t(this).data("tab")+'"] .tab-filter-count');i.attr("data-count",e),i.find(".count").text(e)}),e},i.prototype.clear=function(){return this.$form[0].reset(),this.$form.find("select").selectpicker("refresh"),t(".datetimepickerinput").datetimepicker("clear"),t("input.changed, select.changed",this.$form).removeClass("changed"),t("input, select",this.$form).prop("required",!1),this.countChanges(),t("li",this.$activeFilterList).remove(),t(this.$sortBtn).removeClass("selected"),this.submit(),this},i.prototype.clearFilter=function(e){if(t(e).length){var i,a,r=t(e).data("key"),s=t(e).data("type");switch(s.includes("date")?"date-range"===s?(a="date-range",i=t("#from_"+r,this.$form)):(a="date",i=t("#"+r,this.$form)):a=(i=t("#"+r,this.$form)).length?i[0].type:"unknown",a){case"checkbox":i.prop("checked",!1);break;case"select-one":case"select-multiple":t(i).val(""),t(i).selectpicker("refresh");break;case"date-range":i.closest("fieldset").find(".datetimepickerinput").datetimepicker("clear"),i.closest("fieldset").find(".changed").removeClass("changed");break;default:i.val("")}return t(i).removeClass("changed"),this}},i.prototype.sort=function(e){var i=t(e.target).closest(".dropdown-item"),a=t(".btn-label",i).text();return t(i).hasClass("default")?t(this.$sortBtn).removeClass("selected"):(t(this.$sortBtn).addClass("selected").data({property:i.data("property"),direction:i.data("direction")}),t(".sort-option",this.$sortBtn).find(".sort-option-value").text(a)),this.submit(),this},i.prototype.filterObj=function(e,i,a){var r=t(e).closest(".form-field").data("operator")||"";if(this.name=i,this.value=a,this.operator="=",this.type=e.type,this.parseInvalidBetween=function(t,e){this.type="date",this.value=e,this.operator=t.endsWith("[from]")?">":"<"},r.length&&(this.operator=r),"text"===this.type&&"LIKE"===this.operator&&(this.value="%"+this.value+"%"),"checkbox"===this.type&&(this.value=e.checked),"select-multiple"===this.type&&(this.value=t(e).val(),this.operator="IN"),i.endsWith("[from]")||i.endsWith("[to]")){this.type="daterange",this.operator="BETWEEN",this.matching=i.endsWith("[from]")?i.replace("[from]","[to]"):i.replace("[to]","[from]");var s=t('input[name="'+this.matching+'"]').val();this.value.length&&s.length||(this.value.length?this.parseInvalidBetween(this.name,this.value):this.parseInvalidBetween(this.matching,s))}},i.prototype.submit=function(){var e,i,a,r,s=[],n=this;return i=Charcoal.Admin.manager(),(a=i.components.widgets).length>0&&(this.$form.serializeArray(),e=this.$form.find(":input.changed"),t.each(e,function(t,e){e.value&&s.push(new n.filterObj(e,e.name,e.value))}),r=this.prepare_request(s),a.forEach(function(t){this.dispatch(r,t)}.bind(this))),this},i.prototype.export=function(){var i,a,r,s,n,o=[],l=this;if(r=Charcoal.Admin.manager(),(s=r.components.widgets).length>0){i=this.$form.serializeArray(),a=this.$form.find(":input.changed"),t.each(a,function(t,e){e.value&&o.push(new l.filterObj(e,e.name,e.value))}),n=this.prepare_request(o),s.forEach(function(t){if("function"==typeof t.set_filters){i={widget_type:t.widget_type(),widget_options:t.widget_options(),with_data:!0};var e=[];n.filters&&e.push(n.filters);var a=[];n.orders&&a.push(n.orders),i.widget_options.collection_config.filters=e||{},i.widget_options.collection_config.orders=a||{}}}.bind(this));var c=Charcoal.Admin.admin_url()+"advanced-search/export"+window.location.search;t(this.$form).addClass("loading"),this.reloadXHR=t.ajax({type:"POST",url:c,data:JSON.stringify(i),dataType:"json",contentType:"application/json"});var d,h,p;d=function(t){if("string"!=typeof t.widget_id)return t.feedbacks.push({level:"error",message:e.loadingFailed}),void h.call(this,t);var i=t.widget_id;if(l.set_id(i),l.add_opts("id",i),l.add_opts("widget_id",i),l.widget_id=i,"string"!=typeof t.file)return t.feedbacks.push({level:"error",message:e.loadingFailed}),void h.call(this,t);window.location.href=Charcoal.Admin.admin_url()+"advanced-search/download?filename="+t.file},h=function(t){t.feedbacks.length?Charcoal.Admin.feedback(t.feedbacks):Charcoal.Admin.feedback([{level:"error",message:e.loadingFailed}])},p=function(){l.suppress_feedback()||Charcoal.Admin.feedback().dispatch(),t(l.$form).removeClass("loading")},Charcoal.Admin.resolveSimpleJsonXhr(this.reloadXHR,d,h,p)}return this},i.prototype.prepare_request=function(e){var i,a=null,r=[],s=this.opts("data"),n=t(this.$sortBtn).data("property"),o=this.opts("collection_table");return e.forEach(function(e){var a=e.name.replace(/(\[.*)/gi,""),n=null,l=[];if(void 0!==(i=s.properties_options[a]||{}).table&&i.table!==o&&(n=i.table||null),void 0!==e&&"daterange"===e.type){if("BETWEEN"===e.operator&&e.name.endsWith("[to]"))return!1;var c=t('input[name="'+e.matching+'"]').val();l=e.name.endsWith("[from]")?[e.value,c]:[c,e.value]}r.push({conjunction:i.conjunction||"AND",table:n,property:a,value:l.length?l:e.value,operator:e.operator})}),a={filters:null,orders:null},r.length&&(a.filters={filters:r,table:o}),t(this.$sortBtn).hasClass("selected")&&n&&(a.orders={direction:t(this.$sortBtn).data("direction"),mode:t(this.$sortBtn).data("direction"),property:n}),a},i.prototype.dispatch=function(e,i){if(this.isReloading||!i||"function"!=typeof i.set_filters)return this;void 0!==i.pagination&&(i.pagination.page=1);var a=[];e.filters&&a.push(e.filters),i.set_filters(a);var r=[];e.orders&&r.push(e.orders),t(this.$form).addClass("loading"),this.isReloading=!0,i.set_orders(r);var s=this.opts("site_search");if(s.length>0){var n=Charcoal.Admin.manager().get_widget(s);"function"==typeof i.set_search_query&&(n.set_search_query(n.$input.val()),i.set_search_query(n.search_query())),"function"==typeof i.set_filter&&i.set_filter("search",n.search_filters())}return i.reload(function(e){e&&this.setTotalRows(e.widget_data.total_rows),t(this.$form).removeClass("loading"),this.isReloading=!1}.bind(this),!0),this},Charcoal.Admin.Widget_Advanced_Search=i,Charcoal.Admin.Widget_Advanced_Search_Tabs=i}(jQuery);var AdvancedSearchFilterRecap=function(t,e,i){this.$form=t,this.$activeFilterList=e,this.filterObject=void 0,this.parent=i};AdvancedSearchFilterRecap.prototype.refresh=function(){this.buildFilterObjectFromInputs(),this.displayFilters()},AdvancedSearchFilterRecap.prototype.buildFilterObjectFromInputs=function(){var t=[],e=this,i=[];$("input, select",this.$form).each(function(a,r){if(!r.value)return!0;if("checkbox"===r.type&&!$(r).is(":checked"))return!0;var s=e.extractLabelAndValueFromInput(r);s&&(i.includes(s.id)||(i.push(s.id),t.push(s)))}),this.filterObject=t},AdvancedSearchFilterRecap.prototype.extractLabelAndValueFromInput=function(t){var e=null,i=$(t),a=i.attr("id"),r=i.val(),s="input",n=i.closest("fieldset"),o=$("label",n).first().text(),l=i.attr("name");return void 0!==l&&((l.endsWith("[to]")||l.endsWith("[from]"))&&(a=a.replace("from_","").replace("to_",""),e=this.extractFromDateRange(t)),"SELECT"===t.tagName&&(e=this.extractFromSelect(t)),"checkbox"===t.type&&(e=this.extractFromCheckbox(t)),null!==e&&e&&(s=e.type,r=e.val),{id:a,type:s,val:r,name:o})},AdvancedSearchFilterRecap.prototype.extractFromDateRange=function(t){var e=$(t).attr("name").replace("[from]","").replace("[to]","");return{type:"date-range",val:[$('input[name="'+e+'[from]"]').val()||null,$('input[name="'+e+'[to]"]').val()||null].filter(function(t){return null!==t}).join(" - ")}},AdvancedSearchFilterRecap.prototype.extractFromSelect=function(t){return{type:"select",val:Array.from(t.selectedOptions).map(function(t){return t.value?t.innerHTML:null}).filter(function(t){return null!==t}).join(", ")}},AdvancedSearchFilterRecap.prototype.extractFromCheckbox=function(t){return{type:"checkbox",val:$(t).is(":checked")?"fr"===$("html").attr("lang")?"Oui":"Yes":""}},AdvancedSearchFilterRecap.prototype.displayFilters=function(){if(void 0!==this.filterObject){this.$activeFilterList.empty();for(var t in this.filterObject){var e=this.filterObject[t];this.addActiveFilter(e)}}},AdvancedSearchFilterRecap.prototype.addActiveFilter=function(t){var e=t.id,i=t.type,a=t.name,r=t.val,s=$("<li></li>").append($("<span></span>").addClass("label").text(a).attr("title",a)).append($("<span></span>").addClass("value").text(r).attr("title",r)).append($("<div></div>").addClass("remove fa fa-times js-remove-filter")).attr("data-key",e).attr("data-type",i);$(this.$activeFilterList).append(s)},AdvancedSearchFilterRecap.prototype.removeActiveFilter=function(t){var e=$(t).closest("li");e.length&&(this.parent.clearFilter(e),e.remove())};